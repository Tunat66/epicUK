<!-- SPDX-License-Identifier: LGPL-3.0-or-later -->
<!-- Copyright (C) 2022 Sylvester Joosten, Wouter Deconinck, Shujie Li -->

<lccdd>
  <define>
    <comment>
      Main parameters - this is for the more realistic June 2022 design
    </comment>

    <constant name="SiBarrelMod1_rmin"             value="SiBarrel1_rmin+1*mm"/>
    <constant name="SiBarrelMod2_rmin"             value="SiBarrel2_rmin+1*cm"/>
    <constant name="SiBarrelMod_angle"             value="SiBarrel_angle"/>
    <constant name="SiBarrelMod_dz"                value="SiBarrel_dz"/>

    <constant name="SiBarrelSensor_thickness"      value="40*um"/>

    <constant name="SiBarrelMod1Service_thickness" value="0.15*mm"/>
    <constant name="SiBarrelMod2Service_thickness" value="0.37*mm"/>
    <constant name="SiBarrelMod1Frame_thickness"   value="0.06*mm"/>
    <constant name="SiBarrelMod2Frame_thickness"   value="0.12*mm"/>
    <constant name="SiBarrelMod1Frame_height"      value="0.8*cm"/>
    <constant name="SiBarrelMod2Frame_height"      value="0.8*cm"/>
    <constant name="SiBarrelStave1_width"          value="4*cm"/>
    <constant name="SiBarrelStave2_width"          value="4*cm"/>

    <comment>
      Actual parametrization
    </comment>

    <constant name="SiBarrelMod1_length"        value="2 * SiBarrelMod1_rmin / tan(SiBarrelMod_angle) - SiBarrel_dz"/>
    <comment> 84cm=2*42cm is the engineer max </comment>
    <constant name="SiBarrelMod2_length"        value="84*cm"/>

    <constant name="SiBarrelLayer1_length"      value="SiBarrelMod1_length + 1*um"/>
    <constant name="SiBarrelLayer2_length"      value="SiBarrelMod2_length + 1*um"/>
    <constant name="SiBarrelEnvelope_length"    value="SiBarrelLayer2_length + 1*um" />

    <constant name="SiBarrelLayer_thickness"    value="3.0*cm"/>
    <constant name="SiBarrelLayer1_rmin"        value="SiBarrelMod1_rmin "/>
    <constant name="SiBarrelLayer1_rmax"        value="SiBarrelLayer1_rmin + SiBarrelLayer_thickness"/>
    <constant name="SiBarrelLayer2_rmin"        value="SiBarrelMod2_rmin "/>
    <constant name="SiBarrelLayer2_rmax"        value="SiBarrelLayer2_rmin + SiBarrelLayer_thickness"/>

    <constant name="SiBarrelStaveTilt_angle"     value="3.0*degree"/>
    <constant name="SiBarrelStave1_count"        value="floor(180.*degree/asin(SiBarrelStave1_width*cos(SiBarrelStaveTilt_angle)/2/SiBarrelMod1_rmin))+2"/>
    <constant name="SiBarrelStave2_count"        value="floor(180.*degree/asin(SiBarrelStave2_width*cos(SiBarrelStaveTilt_angle)/2/SiBarrelMod2_rmin))+2"/>
  </define>
  
  <comment> 
`   What is new:

    I transplanted the modules and layers of VertexBarrelOuter into here and adjust the DECLARE_DETELEMENT
    macros in the .cpp files to have these new structures of L3 and L4

  </comment>

  <detectors>
    <documentation level="5">
        ### Actual detectors
        Detector L3
    </documentation>
    <detector
      id="TrackerBarrel_0_ID"
      name="SagittaSiBarrel"
      type="epic_SiliconBarrel"
      readout="SiBarrelHits"
      insideTrackingVolume="true">
      <type_flags type="DetType_TRACKER + DetType_BARREL"/>
      <dimensions
        rmin="210 * mm"
        rmax="350 * mm"
        length="840 * mm" /> <!--840 default-->
      <comment>Silicon Barrel Modules</comment>
      <module name="L3Module" vis="TrackerLayerVis">
        <!-- The blank values are defined by the geometry the GDML file anyway, left them
         for consistency. file="install/share/epic/compact/tracking/L3-L4_gdml/centered_ePIC-L3-converted-ASCII.gdml
         file="install/share/epic/gdml/Tile01_Reduced.gdml"-->
        <module_component name="L3Module_active_silicon"
                          material="Silicon"
                          sensitive="true"
                          width="3 * mm"
                          length="840 * mm"
                          thickness="3 * mm"
                          vis="TrackerLayerVis"
                          file="install/share/epic/compact/tracking/L3-L4_gdml/placeholder-gdml/SensorModulePlaceholder-Sensor_Module_AssemblyALICE_active-converted-ASCII.gdml" />
        
        <!--<module_component name="ITS3"
                          material="Silicon"
                          sensitive="true"
                          width="SiBarrelStave1_width"
                          length="SiBarrelMod1_length"
                          thickness="SiBarrelSensor_thickness"
                          vis="TrackerLayerVis" />      -->            
        <module_component name="L3Module_inactive_silicon"
                          material="Silicon"
                          sensitive="false"
                          width="3 * mm"
                          length="840 * mm"
                          thickness="30 * mm"
                          vis="TrackerLayerVis"
                          file="install/share/epic/compact/tracking/L3-L4_gdml/placeholder-gdml/SensorModulePlaceholder-Sensor_Module_AssemblyALICE_inactive-converted-ASCII.gdml" />
        <module_component name="L3Module_kapton"
                          material="Kapton"
                          sensitive="false"
                          width="3 * mm"
                          length="840 * mm"
                          thickness="30 * mm"
                          vis="TrackerLayerVis"
                          file="install/share/epic/compact/tracking/L3-L4_gdml/placeholder-gdml/SensorModulePlaceholder-Sensor_Module_AssemblyKapton_Electrical_Insulation-converted-ASCII.gdml" />
        <module_component name="L3Module_support"
                          material="Carbon"
                          sensitive="false"
                          width="3 * mm"
                          length="840 * mm"
                          thickness="30 * mm"
                          vis="TrackerLayerVis"
                          file="install/share/epic/compact/tracking/L3-L4_gdml/placeholder-gdml/SensorModulePlaceholder-SupportPlaceholder-converted-ASCII.gdml" />
      <!--<module_component name="L3Module_electronic"
                          material="Carbon"
                          sensitive="false"
                          width="3 * mm"
                          length="840 * mm"
                          thickness="3 * mm"
                          vis="TrackerLayerVis"
                          file="install/share/epic/compact/tracking/L3-L4_gdml/placeholder-gdml/SensorModulePlaceholder-Sensor_Module_AssemblyAncillary_FPC-converted-ASCII.gdml" />-->
      </module>
      <layer module="L3Module" id="3" vis="TrackerLayerVis">
        <!-- IDK how to define the envelope values, but they might not be needed??-->
        <!-- I just came up with a rough estimate of the thickness of the modules to 
         define an envelope, THIS WILL CHANGE-->
        <barrel_envelope
          inner_r="SiBarrelLayer1_rmin-10.0*mm"
          outer_r="SiBarrelLayer1_rmax"
          z_length="840 * mm" />
        <layer_material surface="inner" binning="binPhi,binZ" bins0="42" bins1="100" />
        <layer_material surface="outer" binning="binPhi,binZ" bins0="42" bins1="100" />
        <comment>
          phi0     : Starting phi of first module.
          phi_tilt : Phi tilt of a module.
          rc       : Radius of the module center.
          nphi     : Number of modules in phi.
          rphi_dr  : The delta radius of every other module. Will be very useful on our design.

          z0       : Z position of first module in phi.
          nz       : Number of modules to place in z.
          dr       : Radial displacement parameter, of every other module.
        </comment>
        <rphi_layout phi_tilt="0.0*degree" nphi="42" phi0="0.0" rc="SiBarrelMod1_rmin" dr="0 * mm"/> 
        <comment>These values are unused, but left here just in case</comment>
        <z_layout dr="0.0 * mm" z0="480.0 * mm / 2" nz="4"/>
      </layer>
    </detector>



    <documentation level="5">
        ### Actual detectors
        Detector L4
    </documentation>

    <!--
    <detector
      id="TrackerBarrel_1_ID"
      name="OuterSiBarrel"
      type="epic_SiliconBarrel"
      readout="SiBarrelHits"
      insideTrackingVolume="true">
      <type_flags type="DetType_TRACKER + DetType_BARREL"/>
      <dimensions
        rmin="SiBarrelLayer2_rmin"
        rmax="SiBarrelLayer2_rmax"
        length="SiBarrelLayer2_length" />
      <comment>Silicon Barrel Modules</comment>
      <module name="L4Module" vis="TrackerLayerVis">
        <module_component name="L4Module_active_silicon"
                          material="Silicon"
                          sensitive="true"
                          width="3 * mm"
                          length="840 * mm"
                          thickness="3 * mm"
                          vis="TrackerLayerVis"
                          file="install/share/epic/compact/tracking/L3-L4_gdml/placeholder-gdml/SensorModulePlaceholder-Sensor_Module_AssemblyALICE_active-converted-ASCII.gdml" />
        <module_component name="L4Module_inactive_silicon"
                          material="Silicon"
                          sensitive="false"
                          width="3 * mm"
                          length="840 * mm"
                          thickness="3 * mm"
                          vis="TrackerLayerVis"
                          file="install/share/epic/compact/tracking/L3-L4_gdml/placeholder-gdml/SensorModulePlaceholder-Sensor_Module_AssemblyALICE_inactive-converted-ASCII.gdml" />
        <module_component name="L4Module_kapton"
                          material="Kapton"
                          sensitive="false"
                          width="3 * mm"
                          length="840 * mm"
                          thickness="3 * mm"
                          vis="TrackerLayerVis"
                          file="install/share/epic/compact/tracking/L3-L4_gdml/placeholder-gdml/SensorModulePlaceholder-Sensor_Module_AssemblyKapton_Electrical_Insulation-converted-ASCII.gdml" />
        <module_component name="L4Module_support"
                          material="Carbon"
                          sensitive="false"
                          width="3 * mm"
                          length="840 * mm"
                          thickness="3 * mm"
                          vis="TrackerLayerVis"
                          file="install/share/epic/compact/tracking/L3-L4_gdml/placeholder-gdml/SensorModulePlaceholder-SupportPlaceholder-converted-ASCII.gdml" />
      </module>
      <layer module="L4Module" id="4" vis="TrackerLayerVis">
        <barrel_envelope
          inner_r="410 * mm"
          outer_r="430 * mm"
          z_length="840 * mm" />
        <layer_material surface="inner" binning="binPhi,binZ" bins0="64" bins1="100" />
        <layer_material surface="outer" binning="binPhi,binZ" bins0="64" bins1="100" />
        <rphi_layout phi_tilt="0.0*degree" nphi="64" phi0="0.0*degree" rc="420 * mm" dr="10.0 * mm"/>
        <z_layout dr="20.0 * mm" z0="720.0 * mm / 2" nz="6"/>
      </layer>
    </detector>-->
  </detectors>

  <plugins>
    <plugin name="DD4hep_ParametersPlugin">
      <argument value="SagittaSiBarrel"/>
      <argument value="layer_pattern: str=SagittaSiBarrel_layer\d"/>
    </plugin>
    
    <!--<plugin name="DD4hep_ParametersPlugin">
      <argument value="OuterSiBarrel"/>
      <argument value="layer_pattern: str=OuterSiBarrel_layer\d"/>
    </plugin>-->
  </plugins>

  <readouts>
    <readout name="SiBarrelHits">
      <segmentation type="CartesianGridXY" grid_size_x="0.020*mm" grid_size_y="0.020*mm" />
      <id>system:8,layer:4,module:12,sensor:8,x:32:-16,y:-16</id>
    </readout>
  </readouts>

</lccdd>
